# Aggregation Pipeline

An aggregation pipeline consists of one or more stages that process documents:

-   Each stage performs an operation on the input documents. For example, a stage can filter documents, group documents, and calculate values.
-   The documents that are output from a stage are passed to the next stage.
-   An aggregation pipeline can return results for groups of documents. For example, return the total, average, maximum, and minimum values.

## Using `$match` and `$group` stages in Aggregation Pipeline

### `$match`

Filter for documents matching criteria.

`$match` stage filters for documents that meets specified conditions and passes those documents to the next stage of the pipeline.

#### Syntax

Takes one argument, which is a query that works exactly like a find command.

```
{$match: <query>}
```

#### Example

```
db.zips.aggregate([
    {$match: {"state": "CA"}}
])
```

Returns something like this:

```
[
    {
        _id: ObjectId("5c8eccc1caa187d17ca6f4ca"),
        city: 'SAN DIEGO',
        zip: '92121',
        loc: { y: 32.891894, x: 117.203503 },
        pop: 2286,
        state: 'CA'
    },
    {
        _id: ObjectId("5c8eccc1caa187d17ca6f4da"),
        city: 'BANNING',
        zip: '92220',
        loc: { y: 33.92816, x: 116.889928 },
        pop: 22545,
        state: 'CA'
    },
    {
        _id: ObjectId("5c8eccc1caa187d17ca6f382"),
        city: 'LOS ANGELES',
        zip: '90035',
        loc: { y: 34.053096, x: 118.380615 },
        pop: 25723,
        state: 'CA'
    },
    {
        _id: ObjectId("5c8eccc1caa187d17ca6f384"),
        city: 'LOS ANGELES',
        zip: '90037',
        loc: { y: 34.002982, x: 118.286284 },
        pop: 56922,
        state: 'CA'
    },
]
```

**Note :** When using the `$match` stage, place it as early as possible in the pipeline so it can use indexes, because it filters and reduces the number of documents which lessens the amount of processing required.

### `$group`

Create a single document for each distinct value.

`$group` stage groups documents by a group key, and the output is one document for each unique value of the group key.

#### Syntax

```
{
    $group: {
        _id: <expression>, // Group Key
        <field1>: { <accumulator1>: <expression1> },
        ...
    }
}
```

`<accumulator>` is an expression that specifies how to aggregate information for each of the groups.

#### Example

```
{
    $group: {
        _id: "$city",
        totalZips: { $count: { } }
    }
}
```

### Example of `$match` and `$group` aggregation pipeline

```
db.zips.aggregate([
    {
        $match: { "state": "CA" }
    },
    {
        $group: {
            _id: "$city",
            totalZips: { count: { } }
        }
    }
])
```

This returns something like this:

```
[
    { _id: 'SAN DIEGO', totalZips: 1 },
    { _id: 'BANNING', totalZips: 1 },
    { _id: 'LOS ANGELES', totalZipz: 2 }
]
```
